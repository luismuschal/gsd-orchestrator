---
phase: 01-foundation-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - src/server/index.ts
  - src/server/db/schema.sql
  - src/server/db/index.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Server can start on localhost:3000"
    - "Database schema supports repos and workflow runs"
    - "Environment configuration is documented"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies and scripts"
      contains: "fastify"
    - path: "src/server/index.ts"
      provides: "HTTP server entry point"
      min_lines: 30
    - path: "src/server/db/schema.sql"
      provides: "Database schema definition"
      contains: "repos"
    - path: "src/server/db/index.ts"
      provides: "Database connection and queries"
      exports: ["getDb", "initDb"]
  key_links:
    - from: "src/server/index.ts"
      to: "src/server/db/index.ts"
      via: "initDb call on startup"
      pattern: "initDb\\(\\)"
---

<objective>
Initialize project foundation with Fastify backend and SQLite database.

Purpose: Establish the core infrastructure for the local orchestrator—HTTP server for API endpoints and persistent storage for repo configuration and workflow state.

Output: 
- Running Node.js/TypeScript project with Fastify server
- SQLite database with schema for repos and workflow runs
- Development environment configuration
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Node.js project with Fastify server</name>
  <files>
package.json
tsconfig.json
src/server/index.ts
.env.example
.gitignore
  </files>
  <action>
Initialize a Node.js TypeScript project with the following setup:

**1. Initialize package.json:**
```bash
npm init -y
```

**2. Install dependencies:**
```bash
npm install fastify @fastify/cors @fastify/static better-sqlite3
npm install -D typescript @types/node @types/better-sqlite3 tsx
```

**3. Create tsconfig.json:**
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
```

**4. Create src/server/index.ts with basic Fastify server:**
- Import fastify, cors plugin
- Create server instance with logger
- Register CORS (for local dev)
- Add health check route GET /api/health returning { status: "ok" }
- Listen on port 3000
- Add graceful shutdown handling (SIGTERM, SIGINT)

**5. Create .env.example:**
```
PORT=3000
DATABASE_PATH=./data/orchestrator.db
GITHUB_APP_ID=
GITHUB_APP_PRIVATE_KEY_PATH=
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=
GITHUB_WEBHOOK_SECRET=
```

**6. Create .gitignore:**
```
node_modules/
dist/
.env
data/
*.db
*.log
```

**7. Add npm scripts to package.json:**
```json
"scripts": {
  "dev": "tsx watch src/server/index.ts",
  "build": "tsc",
  "start": "node dist/server/index.js"
}
```

Use ESM syntax (import/export) throughout. TypeScript strict mode enabled.
  </action>
  <verify>
Run `npm run dev` and verify server starts without errors. 
Curl `http://localhost:3000/api/health` returns `{"status":"ok"}`.
Stop server with Ctrl+C and verify graceful shutdown.
  </verify>
  <done>
- package.json has all dependencies installed
- TypeScript compiles without errors
- Server starts on port 3000
- Health check endpoint responds
- Graceful shutdown works
  </done>
</task>

<task type="auto">
  <name>Task 2: Set up SQLite database with schema</name>
  <files>
src/server/db/schema.sql
src/server/db/index.ts
src/server/db/types.ts
  </files>
  <action>
Create SQLite database layer using better-sqlite3:

**1. Create src/server/db/schema.sql:**

```sql
-- Tracked repositories
CREATE TABLE IF NOT EXISTS repos (
  id TEXT PRIMARY KEY, -- owner/name format
  owner TEXT NOT NULL,
  name TEXT NOT NULL,
  added_at INTEGER NOT NULL, -- Unix timestamp
  last_polled_at INTEGER, -- Unix timestamp
  UNIQUE(owner, name)
);

-- Workflow runs tracked from GitHub
CREATE TABLE IF NOT EXISTS workflow_runs (
  id INTEGER PRIMARY KEY, -- GitHub run ID
  repo_id TEXT NOT NULL,
  workflow_name TEXT NOT NULL,
  status TEXT NOT NULL, -- queued, in_progress, completed
  conclusion TEXT, -- success, failure, cancelled, skipped
  started_at INTEGER, -- Unix timestamp
  completed_at INTEGER, -- Unix timestamp
  html_url TEXT NOT NULL,
  FOREIGN KEY (repo_id) REFERENCES repos(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_workflow_runs_repo ON workflow_runs(repo_id);
CREATE INDEX IF NOT EXISTS idx_workflow_runs_status ON workflow_runs(status);
```

**2. Create src/server/db/types.ts:**
Define TypeScript interfaces:
- `Repo`: { id, owner, name, addedAt, lastPolledAt? }
- `WorkflowRun`: { id, repoId, workflowName, status, conclusion?, startedAt?, completedAt?, htmlUrl }

Use camelCase for TS, snake_case for SQL.

**3. Create src/server/db/index.ts:**
- Export `initDb()` function that:
  - Creates data/ directory if missing
  - Opens/creates SQLite database at `process.env.DATABASE_PATH` or `./data/orchestrator.db`
  - Runs schema.sql to create tables
  - Returns database instance
- Export `getDb()` function that returns existing db instance (singleton pattern)
- Export query helpers:
  - `addRepo(owner: string, name: string): Repo`
  - `getRepos(): Repo[]`
  - `removeRepo(id: string): void`
  - `addWorkflowRun(run: Omit<WorkflowRun, 'id'>): WorkflowRun`
  - `getWorkflowRuns(repoId: string, limit?: number): WorkflowRun[]`
  - `updateWorkflowRun(id: number, updates: Partial<WorkflowRun>): void`

Use better-sqlite3 prepared statements for all queries. Handle errors with try/catch.

**4. Update src/server/index.ts:**
- Import and call `initDb()` before starting server
- Log "Database initialized" on success
  </action>
  <verify>
Run `npm run dev` and verify:
1. data/ directory created
2. orchestrator.db file created
3. "Database initialized" logged
4. No SQL errors in console

Test database operations in Node REPL:
```javascript
import { addRepo, getRepos } from './src/server/db/index.ts';
addRepo('octocat', 'Hello-World');
console.log(getRepos()); // Should show added repo
```
  </verify>
  <done>
- Database file created on startup
- Schema tables exist (repos, workflow_runs)
- Query helper functions work
- Server starts successfully with database initialized
- No SQL errors or connection issues
  </done>
</task>

</tasks>

<verification>
**Integration check:**
1. Start server with `npm run dev`
2. Verify health endpoint: `curl http://localhost:3000/api/health`
3. Verify database file exists at `./data/orchestrator.db`
4. Check logs show both "Server listening" and "Database initialized"
5. Stop server gracefully with Ctrl+C

**File structure should exist:**
```
github_hoster/
├── package.json
├── tsconfig.json
├── .env.example
├── .gitignore
├── src/
│   └── server/
│       ├── index.ts
│       └── db/
│           ├── schema.sql
│           ├── index.ts
│           └── types.ts
└── data/
    └── orchestrator.db
```
</verification>

<success_criteria>
1. Server starts on localhost:3000 without errors
2. Health check endpoint returns 200 OK
3. SQLite database created with repos and workflow_runs tables
4. Database query helpers can add/retrieve repos
5. TypeScript compiles with no errors
6. Graceful shutdown works (no hanging processes)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-dashboard/01-01-SUMMARY.md`
</output>
